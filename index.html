var unityInstance;
var capturingFrames = false; // Variable to indicate if frame capturing is in progress
var imageData = ""; // Accumulated image data

function captureFrame() {
  if (capturingFrames) {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    const video = document.getElementById('screen-share-video');

    // Check if the video is loaded and ready
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Compress the image using the JPEG algorithm with a quality factor of 0.8
      canvas.toBlob(function(blob) {
        const reader = new FileReader();
        reader.onloadend = function() {
          var chunkSize = 32700; // Adjust the chunk size as needed

          for (var i = 0; i < reader.result.length; i += chunkSize) {
            var chunk = reader.result.substring(i, i + chunkSize);
            unityInstance.SendMessage('ScreenShareManager', 'OnFrameCaptured', chunk);
          }
        };
        reader.readAsDataURL(blob);
      }, 'image/jpeg', 0.8);
    }
  }

  requestAnimationFrame(captureFrame);
}

if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
  // Adjust the viewport for mobile devices
  var meta = document.createElement('meta');
  meta.name = 'viewport';
  meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
  document.getElementsByTagName('head')[0].appendChild(meta);

  var canvas = document.querySelector("#unity-canvas");
  canvas.style.width = "100%";
  canvas.style.height = "100%";
  canvas.style.position = "fixed";

  document.body.style.textAlign = "left";
}

var unityContainer = document.getElementById("unity-container");
var screenShareVideo = document.getElementById("screen-share-video");
var startScreenShareButton = document.getElementById("start-screen-share-button");
var changeScreenButton = document.getElementById("change-screen-button");

startScreenShareButton.addEventListener("click", function() {
  startScreenSharing();
  startScreenShareButton.style.display = "none";
  changeScreenButton.style.display = "block";
});

changeScreenButton.addEventListener("click", function() {
  changeScreenSharing();
});

function startScreenSharing() {
  capturingFrames = true; // Start capturing frames
  screenShareVideo.style.display = "block";

  navigator.mediaDevices.getDisplayMedia({ video: true })
    .then(function(stream) {
      screenShareVideo.srcObject = stream;
      screenShareVideo.play();
      captureFrame(); // Start capturing frames once the video stream has started
    })
    .catch(function(error) {
      console.error('Error starting screen sharing:', error);
    });
}

function changeScreenSharing() {
  capturingFrames = false; // Stop capturing frames
  screenShareVideo.srcObject = null;

  navigator.mediaDevices.getDisplayMedia({ video: true })
    .then(function(stream) {
      screenShareVideo.srcObject = stream;
      screenShareVideo.play();
      capturingFrames = true; // Resume capturing frames with the new screen source
    })
    .catch(function(error) {
      console.error('Error changing screen source:', error);
    });
}

createUnityInstance(document.querySelector("#unity-canvas"), {
  dataUrl: "Build/ScreenShare.data",
  frameworkUrl: "Build/ScreenShare.framework.js",
  codeUrl: "Build/ScreenShare.wasm",
  streamingAssetsUrl: "StreamingAssets",
  companyName: "DefaultCompany",
  productName: "ScreenShare",
  productVersion: "0.1",
  devicePixelRatio: 1,
  screenShareVideo: screenShareVideo,
  startScreenShareButton: startScreenShareButton,
  changeScreenButton: changeScreenButton,
  onProgress: (progress) => {
    console.log(`Unity WebGL progress: ${progress}%`);
  },
  Module: {
    onRuntimeInitialized: () => {
      unityInstance = unityInstance || UnityLoader.instantiate("unity-container", "Build/ScreenShare.json");
    }
  }
});
