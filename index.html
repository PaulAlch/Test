<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity WebGL Player | Vitrine</title>
  <style>
    body {
      display: flex;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
      font-family: Arial, sans-serif;
    }
    #unity-container {
      flex-grow: 1;
      width: 50%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    #screen-share-container {
      flex-grow: 1;
      width: 50%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #231F20;
    }
    #screen-share-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #start-screen-share-button {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 10px;
      background-color: #ffffff;
      border: none;
      cursor: pointer;
    }
    #change-screen-button {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 10px;
      background-color: #ffffff;
      border: none;
      cursor: pointer;
    }
    .window-title {
      font-size: 24px;
      font-weight: bold;
      margin-top: 20px;
      color: white;
    }
  </style>
</head>
<body>
<div id="unity-container">
  <div class="window-title">JEU</div>
  <canvas id="unity-canvas"></canvas>
</div>
<div id="screen-share-container">
  <div class="window-title">Partage d'écran</div>
  <video id="screen-share-video"></video>
  <button id="change-screen-button">Changer la source d'écran</button>
</div>
<button id="start-screen-share-button">Commencer le partage d'écran</button>

<script src="Build/ScreenShare.loader.js"></script>
<script>
  var unityInstance;
  var capturingFrames = false;

  function captureFrame() {
    if (capturingFrames) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const video = document.getElementById('screen-share-video');

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function (blob) {
          const reader = new FileReader();
          reader.onloadend = function () {
            var base64Data = reader.result.split(',')[1];
            unityInstance.SendMessage('ScreenShareManager', 'SendScreenDataToOtherPlayer', base64Data);
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.025);
      }
    }

    requestAnimationFrame(captureFrame);
  }

  function adjustCanvasSize() {
    const unityCanvas = document.getElementById('unity-canvas');
    const unityContainer = document.getElementById('unity-container');
    const screenShareContainer = document.getElementById('screen-share-container');
    const screenShareVideo = document.getElementById('screen-share-video');

    unityCanvas.width = unityContainer.offsetWidth;
    unityCanvas.height = unityContainer.offsetHeight;
    screenShareVideo.width = screenShareContainer.offsetWidth;
    screenShareVideo.height = screenShareContainer.offsetHeight;
  }

  function startScreenSharing() {
    capturingFrames = true;
    screenShareContainer.style.display = 'block';

    navigator.mediaDevices.getDisplayMedia({video: true})
      .then(function (stream) {
        screenShareVideo.srcObject = stream;
        screenShareVideo.play();
        captureFrame();
      })
      .catch(function (error) {
        console.error('Erreur lors du partage d\'écran :', error);
      });
  }

  function changeScreenSharing() {
    capturingFrames = false;
    screenShareVideo.srcObject = null;

    navigator.mediaDevices.getDisplayMedia({video: true})
      .then(function (stream) {
        screenShareVideo.srcObject = stream;
        screenShareVideo.play();
        capturingFrames = true;
      })
      .catch(function (error) {
        console.error('Erreur lors du changement de source d\'écran :', error);
      });
  }

  function setupResponsiveBehavior() {
    adjustCanvasSize();
    window.addEventListener('resize', adjustCanvasSize);
  }

  startScreenShareButton.addEventListener('click', function () {
    startScreenSharing();
    startScreenShareButton.style.display = 'none';
    changeScreenButton.style.display = 'block';
  });

  changeScreenButton.addEventListener('click', function () {
    changeScreenSharing();
  });

  createUnityInstance(document.querySelector('#unity-canvas'), {
    dataUrl: 'Build/ScreenShare.data',
    frameworkUrl: 'Build/ScreenShare.framework.js',
    codeUrl: 'Build/ScreenShare.wasm',
    streamingAssetsUrl: 'StreamingAssets',
    companyName: 'DefaultCompany',
    productName: 'Vitrine',
    productVersion: '0.1.0',
  }).then(function (instance) {
    unityInstance = instance;
    setupResponsiveBehavior();
  });
</script>
</body>
</html>
